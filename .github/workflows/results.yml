name: Nuclei - Per Domain Scan

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  nuclei:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Ensure result folder exists
      - name: Create result folder
        run: mkdir -p result

      # Cache Nuclei templates
      - name: Cache Nuclei Templates
        uses: actions/cache@v3
        with:
          path: ~/.nuclei-templates
          key: nuclei-templates-${{ runner.os }}-${{ hashFiles('**/nuclei-templates/**') }}
          restore-keys: |
            nuclei-templates-

      # Install Nuclei CLI
      - name: Install Nuclei
        run: |
          curl -sSfL https://github.com/projectdiscovery/nuclei/releases/latest/download/nuclei_${{ runner.os }}_amd64.zip -o nuclei.zip
          unzip nuclei.zip
          sudo mv nuclei /usr/local/bin/
          nuclei -version

      # Run Nuclei per domain with exclusions
      - name: Run Nuclei Scans
        run: |
          EXCLUDE_TEMPLATES="http/default-logins,code,code/cves,http/cnvd"
          for file in live/*_live.txt; do
            domain=$(basename "$file" _live.txt)
            echo "[*] Running Nuclei scan for $domain"
            nuclei \
              -l "$file" \
              -severity critical,high,medium,low \
              -stats \
              -templates ~/.nuclei-templates \
              -exclude-templates $EXCLUDE_TEMPLATES \
              -o "result/${domain}_nuclei.txt"
          done

      # Commit and push results back to GitHub
      - name: Commit Results to GitHub
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git pull --rebase origin main || true
          git add result/*.txt
          git commit -m "Update Nuclei per-domain scan results [${{ github.sha }}]" || echo "No new changes to commit"
          git push origin main || echo "Push skipped"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

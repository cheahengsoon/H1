name: Nuclei - Per Domain Scan

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main

jobs:
  nuclei:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nuclei using Homebrew (Linuxbrew)
        run: |
          if ! command -v nuclei &> /dev/null; then
            echo "[*] Installing Nuclei using Homebrew..."
            brew install projectdiscovery/tap/nuclei
          else
            echo "[*] Nuclei is already installed."
          fi

      - name: Install Nuclei using Go (Golang)
        run: |
          if ! command -v nuclei &> /dev/null; then
            echo "[*] Installing Nuclei using Go..."
            go install github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest
          else
            echo "[*] Nuclei is already installed."
          fi

      - name: Install Nuclei using Docker
        run: |
          if ! docker run --rm projectdiscovery/nuclei -version &> /dev/null; then
            echo "[*] Installing Nuclei using Docker..."
            docker pull projectdiscovery/nuclei
          else
            echo "[*] Nuclei Docker image is already available."
          fi

      - name: Run Nuclei for each domain file
        run: |
          mkdir -p result
          for file in live/*_live.txt; do
            domain=$(basename "$file" _live.txt)
            echo "[*] Running Nuclei scan for $domain"
            nuclei -l "$file" -severity critical,high,medium,low -stats -rl 150 -c 25 -o "result/${domain}_nuclei.txt"
          done

      - name: Show results
        run: ls -lh result && head -n 20 result/*_nuclei.txt || echo "No findings"

      - name: Save results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-results-${{ github.sha }}
          path: result/

      # Optional: Commit results back to repo
      - name: Commit results back to repo
        if: github.ref == 'refs/heads/main'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git pull --rebase origin main || true
          git add result/*_nuclei.txt
          git commit -m "Update Nuclei results for ${{ github.sha }}" || echo "No new findings"
          git push origin main || echo "Push skipped"

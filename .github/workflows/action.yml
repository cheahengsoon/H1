name: üí• Subdomain Discovery, HTTP Probing & Nuclei Scan

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: üìÇ Create Output folder
        run: mkdir -p Output

      - name: üõ†Ô∏è Install Go
        run: |
          sudo apt-get update
          sudo apt-get install -y golang-go git
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: üîÑ Check & Update Subfinder, httpx, and Nuclei
        run: |
          echo "Checking Subfinder version..."
          if ! command -v subfinder &> /dev/null; then
            echo "Subfinder not found, installing..."
            go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          else
            INSTALLED=$(subfinder -version | awk '{print $NF}')
            echo "Installed Subfinder version: $INSTALLED"
            echo "Updating Subfinder to latest..."
            go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          fi

          echo "Checking httpx version..."
          if ! command -v httpx &> /dev/null; then
            echo "httpx not found, installing..."
            go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          else
            INSTALLED=$(httpx -version | awk '{print $NF}')
            echo "Installed httpx version: $INSTALLED"
            echo "Updating httpx to latest..."
            go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          fi

          echo "Checking Nuclei version..."
          if ! command -v nuclei &> /dev/null; then
            echo "Nuclei not found, installing..."
            go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          else
            INSTALLED=$(nuclei -version | awk '{print $NF}')
            echo "Installed Nuclei version: $INSTALLED"
            echo "Updating Nuclei to latest..."
            go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          fi

      - name: üîé Run Subfinder
        run: |
          echo "Discovering subdomains for gov.sg..."
          subfinder -d gov.sg -o Output/subdomains.txt

      - name: üí• Run httpx scan
        run: |
          echo "Probing live HTTP servers..."
          httpx -l Output/subdomains.txt -o Output/httpx_results.txt

      - name: üñ•Ô∏è List live URLs
        run: |
          echo "Live URLs found:"
          if [ -s Output/httpx_results.txt ]; then
            cat Output/httpx_results.txt
          else
            echo "No live URLs found."
          fi

      - name: ‚ö° Run Nuclei scan (Critical, High, Medium, Low)
        run: |
          echo "Running Nuclei scan on live URLs..."
          nuclei -l Output/httpx_results.txt -severity critical,high,medium,low -o Output/nuclei_results.txt

      - name: üìù Commit and push results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add Output/httpx_results.txt Output/nuclei_results.txt
          git commit -m "Update httpx and Nuclei scan results [skip ci]" || echo "No changes to commit"
          git push

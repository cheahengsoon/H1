name: Multi-Repository CodeQL Scan

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * 0"  # Weekly scan

permissions:
  contents: read
  security-events: write

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix:
        include:
          # ---------- BigBlueButton ----------
          - repo: bigbluebutton/bigbluebutton
            language: javascript
            build: |
              npm install || true
              npm run build --if-present || true

          - repo: blindsidenetworks/scalelite
            language: ruby
            build: |
              bundle install || true

          - repo: bigbluebutton/bbb-webrtc-sfu
            language: javascript
            build: |
              npm ci || true

          - repo: bigbluebutton/bbb-webrtc-recorder
            language: javascript
            build: |
              npm ci || true

          - repo: bigbluebutton/greenlight
            language: ruby
            build: |
              bundle install || true

          - repo: bigbluebutton/bbb-presentation-video
            language: javascript
            build: |
              npm install || true

          - repo: bigbluebutton/bbb-playback
            language: javascript
            build: |
              npm install || true

          # ---------- ExpressVPN ----------
          - repo: expressvpn/lightway
            language: cpp
            build: |
              mkdir build
              cd build
              cmake ..
              make -j$(nproc)

          # ---------- Jenkins ----------
          - repo: jenkinsci/jenkins
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/stapler
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/jelly
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/winstone
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/script-security-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/credentials-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/credentials-binding-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/workflow-cps-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/ldap-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/ssh-credentials-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/plain-credentials-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/matrix-auth-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/ssh-agents-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/git-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/git-client-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          - repo: jenkinsci/workflow-scm-step-plugin
            language: java
            build: |
              mvn -B -DskipTests package

          # ---------- Nextcloud ----------
          - repo: nextcloud/server
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/activity
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/bruteforcesettings
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/circles
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/files_pdfviewer
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/firstrunwizard
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/logreader
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/nextcloud_announcements
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/notifications
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/password_policy
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/photos
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/privacy
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/recommendations
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/related_resources
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/serverinfo
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/survey_client
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/suspicious_login
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/text
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/twofactor_totp
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/updater
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/user_saml
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/viewer
            language: javascript
            build: |
              npm install || true

          - repo: nextcloud/android
            language: java
            build: |
              ./gradlew assemble || true

          - repo: nextcloud/ios
            language: swift
            build: |
              xcodebuild -scheme Nextcloud -sdk iphonesimulator || true

          - repo: nextcloud/desktop
            language: cpp
            build: |
              mkdir build
              cd build
              cmake ..
              make -j$(nproc)

          # ---------- OpenProject ----------
          - repo: opf/openproject
            language: ruby
            build: |
              bundle install || true

          # ---------- Pendulum ----------
          - repo: pendulum-project/ntpd-rs
            language: cpp
            build: |
              cargo build --release

          - repo: pendulum-project/timestamped-socket
            language: cpp
            build: |
              cargo build --release

          - repo: pendulum-project/clock-steering
            language: cpp
            build: |
              cargo build --release

          # ---------- ownCloud ----------
          - repo: owncloud/customgroups
            language: php
            build: |
              composer install || true

          - repo: owncloud/guests
            language: php
            build: |
              composer install || true

          - repo: owncloud/richdocuments
            language: php
            build: |
              composer install || true

          - repo: owncloud/notifications
            language: php
            build: |
              composer install || true

          - repo: owncloud/client
            language: cpp
            build: |
              mkdir build
              cd build
              cmake ..
              make -j$(nproc)

          - repo: owncloud/core
            language: php
            build: |
              composer install || true

          - repo: owncloud/gallery
            language: php
            build: |
              composer install || true

          - repo: owncloud/ocis
            language: go
            build: |
              go build ./...

          - repo: owncloud/web
            language: php
            build: |
              composer install || true

          - repo: owncloud/web-extensions
            language: php
            build: |
              composer install || true

          - repo: owncloud/user_ldap
            language: php
            build: |
              composer install || true

          - repo: owncloud/oauth2
            language: php
            build: |
              composer install || true

          - repo: owncloud/openidconnect
            language: php
            build: |
              composer install || true

          - repo: owncloud/activity
            language: php
            build: |
              composer install || true

          - repo: owncloud/impersonate
            language: php
            build: |
              composer install || true

          - repo: owncloud/updater
            language: php
            build: |
              composer install || true

          - repo: owncloud/android
            language: java
            build: |
              ./gradlew assemble || true

          - repo: owncloud/ios-app
            language: swift
            build: |
              xcodebuild -scheme ownCloud -sdk iphonesimulator || true

    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          path: target
          fetch-depth: 0

      - name: Setup Toolchains
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config \
            maven golang rustc cargo ruby-full php-cli composer \
            npm nodejs

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          source-root: target
          queries: security-and-quality

      - name: Build Project
        working-directory: target
        run: ${{ matrix.build }}

      - name: Analyze
        uses: github/codeql-action/analyze@v3
